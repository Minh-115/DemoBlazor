- name: Run AI Review
  id: ai-review
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  run: |
    DIFF=$(cat diff.patch | head -c 15000)

    RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $OPENAI_API_KEY" \
      -d "{
        \"model\": \"gpt-4o-mini\",
        \"messages\": [
          {\"role\": \"system\", \"content\": \"Bạn là code reviewer chuyên nghiệp, hãy review diff code và nêu nhận xét rõ ràng, ngắn gọn\"},
          {\"role\": \"user\", \"content\": \"$DIFF\"}
        ]
      }")

    echo "=== RAW RESPONSE ==="
    echo "$RESPONSE"

    REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "❌ Không có phản hồi từ OpenAI"')

    echo "review<<EOF" >> $GITHUB_OUTPUT
    echo "$REVIEW" >> $GITHUB_OUTPUT
    echo "EOF" >> $GITHUB_OUTPUT
